@page "/monitor"
@using Microsoft.AspNetCore.SignalR.Client
@using BlazorSignals.Shared;
@inject NavigationManager _navigation
@inject IJSRuntime _jsRunTime
@implements IAsyncDisposable

<h3>Real Time Sensor</h3>
<hr />
<p>This is an experiment on providing Real-time Charts</p>
<table class="table table-bordered">
    <tr>
        <td>Sender</td>
        <td>@SensorSender</td>
    </tr>
    <tr>
        <td>Signal Time</td>
        <td>@SensorTime</td>
    </tr>
    <tr>
        <td>Sensor Value</td>
        <td>@SensorValue</td>
    </tr>
</table>
<br />
<canvas id="chart" style="width: 100%; height: 320px"></canvas>
<br />
<pre id="echo">@Status</pre>

@code {
    HubConnection connection;
    string SensorSender { get; set; } = "Tepeature Gradient, C";
    string SensorTime { get; set; } = "00:00:00.000";
    string SensorValue { get; set; } = "0.000000";
    string Status { get; set; }

    IJSObjectReference _module;

    protected override async Task OnInitializedAsync()
    {
        var url = _navigation.ToAbsoluteUri("/sensorHub");
        try {
            // interoperability
            _module = await _jsRunTime.InvokeAsync<IJSObjectReference>("import", "./modules/chart-sensor.js?v=1.0");
            await _module.InvokeVoidAsync("init");
            // signalr
            connection = new HubConnectionBuilder().WithUrl(url).Build();
            // to subscribe, map exactly the hub's function
            connection.On<string, Pulse>("Broadcast", (sender, pulse) => {
                SensorTime = pulse.Timestamp.ToString("HH:mm:ss.fff");
                SensorValue = pulse.Value.ToString("N6");
                StateHasChanged();
                // interoperability
                _module.InvokeVoidAsync("updateChart", pulse);
            });
            await connection.StartAsync();
        }
        catch (Exception exception) {
            Status = $"Exception: {exception.Message}";
            return;
        }
        Status = $"Status: {(IsConnected ? "Waiting for broadcast events." : "Without connection")}";
    }

    public bool IsConnected => connection.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync() => await connection.DisposeAsync();
}


